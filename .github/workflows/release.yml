name: Build and Release

on:
  push:
    branches:
      - main # Draft releases on regular pushes
    tags: # Published releases on version tags
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore Switcheroo.sln

      - name: Determine version
        id: ver
        run: |
          git fetch --tags --force
          $lastTag = (& git tag -l "v*" --sort=-v:refname | Select-Object -First 1)
          if ([string]::IsNullOrWhiteSpace($lastTag)) { $lastTag = "v9.3.0" }

          if ("${{ github.ref }}" -match "^refs/tags/v") {
            # Official release from tag (e.g., v9.4.0)
            $base = "${{ github.ref_name }}".TrimStart('v') -replace '-.*','' -replace '\+.*',''
            $parts = $base.Split('.'); while ($parts.Count -lt 3) { $parts += '0' }
            $maj=[int]$parts[0]; $min=[int]$parts[1]; $pat=[int]$parts[2]

            $run="${{ github.run_number }}"

            $VERSION      = "v$maj.$min.$pat.$run"
            $ASM_VERSION  = "$maj.$min.$pat.$run"                         # numeric only
            $IS_DRAFT     = "false"
            $RELEASE_NAME = "Release $VERSION"
          }
          else {
            # Dev build: next PATCH, revision = run number
            $norm = $lastTag.TrimStart('v') -replace '-.*','' -replace '\+.*',''
            $p = $norm.Split('.'); while ($p.Count -lt 3) { $p += '0' }
            $maj=[int]$p[0]; $min=[int]$p[1]; $pat=[int]$p[2]

            $maj2=$maj; $min2=$min; $pat2=$pat+1
            $run="${{ github.run_number }}"
            $shaShort = "${{ github.sha }}".Substring(0,7)

            $VERSION     = "v$maj2.$min2.$pat2.$run"                   # v9.4.0.123
            $ASM_VERSION = "$maj2.$min2.$pat2.$run"                    # 9.4.0.123
            $IS_DRAFT    = "true"
            $RELEASE_NAME = "Draft Build - v$maj2.$min2.$pat2-dev.$run+sha.$shaShort"

            # Create a temp tag:
            git tag -f "$VERSION" ${{ github.sha }}
          }
          "VERSION=$VERSION"           | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "ASM_VERSION=$ASM_VERSION"   | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "IS_DRAFT=$IS_DRAFT"         | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "RELEASE_NAME=$RELEASE_NAME" | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "LAST_TAG=$lastTag"          | Out-File $env:GITHUB_ENV -Append -Encoding utf8
        shell: pwsh
      
      - name: Update AssemblyInfo # Ensure that generated releases have correct version numbers
        run: |
          $version = "${{ env.ASM_VERSION }}"
          $files = Get-ChildItem -Path . -Filter "AssemblyInfo.cs" -Recurse
          foreach ($file in $files) {
            (Get-Content $file.FullName) |
            ForEach-Object { $_ -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(""$version"")" } |
            ForEach-Object { $_ -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(""$version"")" } |
            Set-Content $file.FullName
          }
        shell: pwsh

      - name: Build Installers
        run: msbuild Installer\Build.xml /t:Main /p:Configuration=Release /p:Platform="AnyCPU"

      - name: Build changelog from conventional commits
        id: changelog
        uses: requarks/changelog-action@v1
        # if: startsWith(github.ref, 'refs/tags/')
        with:
          token: ${{ github.token }}
          fromTag: ${{ github.sha }}
          toTag: ${{ env.LAST_TAG }}
          writeToFile: false

      - name: Rename artifacts with version
        shell: pwsh
        run: |
          $ver = "${{ env.ASM_VERSION }}"
          $out = "Installer/Output"

          $instSrc = Join-Path $out "switcheroo-setup.exe"
          $portSrc = Join-Path $out "switcheroo-portable.zip"

          if (!(Test-Path $instSrc)) { throw "Missing $instSrc" }
          if (!(Test-Path $portSrc)) { throw "Missing $portSrc" }

          $instDst = Join-Path $out ("Switcheroo-Installer-{0}.exe" -f $ver)
          $portDst = Join-Path $out ("Switcheroo-Portable-{0}.zip" -f $ver)

          Move-Item -Force $instSrc $instDst
          Move-Item -Force $portSrc $portDst

          $instDst = $instDst -replace '\\','/'
          $portDst = $portDst -replace '\\','/'

          "INSTALLER_PATH=$instDst" | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "PORTABLE_PATH=$portDst"  | Out-File $env:GITHUB_ENV -Append -Encoding utf8

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          target_commitish: ${{ github.sha }}
          draft: ${{ env.IS_DRAFT == 'true' }}
          files: |
            ${{ env.INSTALLER_PATH }}
            ${{ env.PORTABLE_PATH }}
          fail_on_unmatched_files: true
          generate_release_notes: false
          name: ${{ env.RELEASE_NAME }}
          body: ${{ steps.changelog.outputs.changes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}